# Story 1.2: User Authentication

## Status
**Draft**

## Story

**As a** user,  
**I want** to create an account and log in with email/password,  
**so that** I can access the messaging app securely.

## Acceptance Criteria

1. Login screen with email and password input fields
2. Sign up screen with email, password, display name, and optional profile picture
3. Firebase Auth integration for email/password authentication
4. User data stored in Firestore `users` collection with: userId, email, displayName, profilePictureURL, createdAt, lastSeen
5. Authentication state persisted across app restarts (Expo SecureStore)
6. Navigation redirects authenticated users to conversation list, unauthenticated to login
7. Basic error handling for invalid credentials, duplicate accounts
8. Logout functionality clears authentication state

## Tasks / Subtasks

- [ ] **Task 1: Create Auth Store with Zustand** (AC: 5, 6, 8)
  - [ ] Install Zustand: `npm install zustand`
  - [ ] Create `mobile/src/stores/authStore.ts`
  - [ ] Define `AuthState` interface: user, isAuthenticated, isLoading
  - [ ] Implement actions: login(), signup(), logout(), setUser()
  - [ ] Add persist middleware with Expo SecureStore for token persistence
  - [ ] Export `useAuthStore` hook

- [ ] **Task 2: Create Firestore Users Service** (AC: 4)
  - [ ] Create `mobile/src/services/firestore/usersService.ts`
  - [ ] Implement `createUserDocument(user: User): Promise<void>`
  - [ ] Implement `getUserDocument(userId: string): Promise<User | null>`
  - [ ] Implement `updateUserPresence(userId: string, isOnline: boolean): Promise<void>`
  - [ ] Export service functions

- [ ] **Task 3: Create Login Screen** (AC: 1, 7)
  - [ ] Create `mobile/src/components/screens/LoginScreen.tsx`
  - [ ] Add email TextInput (React Native Paper)
  - [ ] Add password TextInput with secure entry
  - [ ] Add "Login" button that calls `authStore.login()`
  - [ ] Add "Don't have account? Sign up" link to navigate to signup
  - [ ] Display error messages for invalid credentials
  - [ ] Show loading spinner during authentication

- [ ] **Task 4: Create Signup Screen** (AC: 2, 7)
  - [ ] Create `mobile/src/components/screens/SignupScreen.tsx`
  - [ ] Add email TextInput
  - [ ] Add password TextInput (min 6 characters validation)
  - [ ] Add display name TextInput
  - [ ] Add "Sign Up" button that calls `authStore.signup()`
  - [ ] Add "Already have account? Login" link
  - [ ] Handle duplicate account errors
  - [ ] Show loading spinner during signup

- [ ] **Task 5: Implement Auth Flow Logic** (AC: 3, 4, 5)
  - [ ] In `authStore.login()`: call Firebase `signInWithEmailAndPassword()`
  - [ ] Fetch user document from Firestore after successful login
  - [ ] Store user in Zustand state and persist auth token
  - [ ] In `authStore.signup()`: call Firebase `createUserWithEmailAndPassword()`
  - [ ] Create User document in Firestore with all required fields
  - [ ] Store new user in state
  - [ ] In `authStore.logout()`: call Firebase `signOut()` and clear state

- [ ] **Task 6: Set Up Protected Routes with Expo Router** (AC: 6)
  - [ ] Create `mobile/src/app/_layout.tsx` (root layout)
  - [ ] Check `authStore.isAuthenticated` in root layout
  - [ ] Redirect to `/login` if not authenticated
  - [ ] Redirect to `/(tabs)` if authenticated
  - [ ] Create `mobile/src/app/(auth)/_layout.tsx` for auth routes
  - [ ] Create `mobile/src/app/(auth)/login.tsx` route
  - [ ] Create `mobile/src/app/(auth)/signup.tsx` route

- [ ] **Task 7: Create Placeholder Conversation List Screen** (AC: 6)
  - [ ] Create `mobile/src/app/(tabs)/_layout.tsx` with tab navigation
  - [ ] Create `mobile/src/app/(tabs)/index.tsx` (conversations list placeholder)
  - [ ] Show "Welcome, {displayName}!" message
  - [ ] Add logout button that calls `authStore.logout()`
  - [ ] Verify authenticated user is redirected here after login

## Dev Notes

### Data Models
[Source: docs/architecture.md#data-models]

```typescript
// shared/src/types/models.ts
export interface User {
  id: string;                    // Firebase Auth UID
  email: string;
  displayName: string;
  profilePictureURL: string | null;
  isOnline: boolean;
  lastSeen: Date;
  fcmToken: string | null;       // Will be added in Story 1.9
  createdAt: Date;
}
```

### Firestore Collection Structure
[Source: docs/architecture.md#database-schema]

Collection: `/users/{userId}`
- Document ID = Firebase Auth UID
- Fields: email, displayName, profilePictureURL, isOnline, lastSeen, fcmToken, createdAt

### Zustand Store Pattern
[Source: docs/architecture.md#frontend-architecture]

```typescript
// mobile/src/stores/authStore.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import * as SecureStore from 'expo-secure-store';
import { User } from '@messageai/shared';
import { auth } from '../services/firebase/config';
import { createUserDocument, getUserDocument } from '../services/firestore/usersService';

interface AuthState {
  user: User | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  
  login: (email: string, password: string) => Promise<void>;
  signup: (email: string, password: string, displayName: string) => Promise<void>;
  logout: () => Promise<void>;
  setUser: (user: User | null) => void;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set) => ({
      user: null,
      isAuthenticated: false,
      isLoading: false,
      
      login: async (email, password) => {
        set({ isLoading: true });
        try {
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          const userDoc = await getUserDocument(userCredential.user.uid);
          set({ user: userDoc, isAuthenticated: true, isLoading: false });
        } catch (error) {
          set({ isLoading: false });
          throw error;
        }
      },
      
      signup: async (email, password, displayName) => {
        set({ isLoading: true });
        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const newUser: User = {
            id: userCredential.user.uid,
            email,
            displayName,
            profilePictureURL: null,
            isOnline: true,
            lastSeen: new Date(),
            fcmToken: null,
            createdAt: new Date(),
          };
          await createUserDocument(newUser);
          set({ user: newUser, isAuthenticated: true, isLoading: false });
        } catch (error) {
          set({ isLoading: false });
          throw error;
        }
      },
      
      logout: async () => {
        await signOut(auth);
        set({ user: null, isAuthenticated: false });
      },
      
      setUser: (user) => set({ user, isAuthenticated: !!user }),
    }),
    {
      name: 'auth-storage',
      storage: {
        getItem: async (name) => {
          const value = await SecureStore.getItemAsync(name);
          return value ? JSON.parse(value) : null;
        },
        setItem: async (name, value) => {
          await SecureStore.setItemAsync(name, JSON.stringify(value));
        },
        removeItem: async (name) => {
          await SecureStore.deleteItemAsync(name);
        },
      },
    }
  )
);
```

### Protected Route Pattern
[Source: docs/architecture.md#frontend-architecture]

```typescript
// mobile/src/app/_layout.tsx
import { useEffect } from 'react';
import { Slot, useRouter, useSegments } from 'expo-router';
import { useAuthStore } from '../stores/authStore';

export default function RootLayout() {
  const { isAuthenticated, isLoading } = useAuthStore();
  const segments = useSegments();
  const router = useRouter();
  
  useEffect(() => {
    if (isLoading) return;
    
    const inAuthGroup = segments[0] === '(auth)';
    
    if (!isAuthenticated && !inAuthGroup) {
      router.replace('/login');
    } else if (isAuthenticated && inAuthGroup) {
      router.replace('/');
    }
  }, [isAuthenticated, isLoading, segments]);
  
  if (isLoading) {
    return <LoadingScreen />;
  }
  
  return <Slot />;
}
```

### Error Handling
[Source: docs/architecture.md#frontend-architecture]

Common Firebase Auth error codes to handle:
- `auth/email-already-in-use` - Email exists (signup)
- `auth/invalid-email` - Invalid email format
- `auth/user-not-found` - No account with email (login)
- `auth/wrong-password` - Incorrect password (login)
- `auth/weak-password` - Password < 6 characters (signup)

### Dependencies to Install
- `zustand` - State management
- `expo-secure-store` - Secure token storage
- `react-native-paper` - UI components (TextInput, Button)
- `firebase` - Already installed in Story 1.1

### Testing
[Source: docs/architecture.md#testing-strategy]
- **Manual Testing:** Create account, log in, log out, restart app (verify persistence)
- **Test Scenarios:**
  - Sign up with new email → should succeed
  - Sign up with existing email → should show error
  - Log in with wrong password → should show error
  - Log in successfully → should navigate to conversations list
  - Restart app after login → should stay logged in

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

## QA Results

_To be filled by QA agent_

