# Story 1.2: User Authentication

## Status
**Ready for Review**

## Story

**As a** user,  
**I want** to create an account and log in with email/password,  
**so that** I can access the messaging app securely.

## Acceptance Criteria

1. Login screen with email and password input fields
2. Sign up screen with email, password, display name, and optional profile picture
3. Firebase Auth integration for email/password authentication
4. User data stored in Firestore `users` collection with: userId, email, displayName, profilePictureURL, createdAt, lastSeen
5. Authentication state persisted across app restarts (Expo SecureStore)
6. Navigation redirects authenticated users to conversation list, unauthenticated to login
7. Basic error handling for invalid credentials, duplicate accounts
8. Logout functionality clears authentication state

## Tasks / Subtasks

- [x] **Task 1: Create Auth Store with Zustand** (AC: 5, 6, 8)
  - [x] Install Zustand: `npm install zustand`
  - [x] Create `mobile/src/stores/authStore.ts`
  - [x] Define `AuthState` interface: user, isAuthenticated, isLoading
  - [x] Implement actions: login(), signup(), logout(), setUser()
  - [x] Add persist middleware with Expo SecureStore for token persistence
  - [x] Export `useAuthStore` hook

- [x] **Task 2: Create Firestore Users Service** (AC: 4)
  - [x] Create `mobile/src/services/firestore/usersService.ts`
  - [x] Implement `createUserDocument(user: User): Promise<void>`
  - [x] Implement `getUserDocument(userId: string): Promise<User | null>`
  - [x] Implement `updateUserPresence(userId: string, isOnline: boolean): Promise<void>`
  - [x] Export service functions

- [x] **Task 3: Create Login Screen** (AC: 1, 7)
  - [x] Create `mobile/src/components/screens/LoginScreen.tsx`
  - [x] Add email TextInput (React Native Paper)
  - [x] Add password TextInput with secure entry
  - [x] Add "Login" button that calls `authStore.login()`
  - [x] Add "Don't have account? Sign up" link to navigate to signup
  - [x] Display error messages for invalid credentials
  - [x] Show loading spinner during authentication

- [x] **Task 4: Create Signup Screen** (AC: 2, 7)
  - [x] Create `mobile/src/components/screens/SignupScreen.tsx`
  - [x] Add email TextInput
  - [x] Add password TextInput (min 6 characters validation)
  - [x] Add display name TextInput
  - [x] Add "Sign Up" button that calls `authStore.signup()`
  - [x] Add "Already have account? Login" link
  - [x] Handle duplicate account errors
  - [x] Show loading spinner during signup

- [x] **Task 5: Implement Auth Flow Logic** (AC: 3, 4, 5)
  - [x] In `authStore.login()`: call Firebase `signInWithEmailAndPassword()`
  - [x] Fetch user document from Firestore after successful login
  - [x] Store user in Zustand state and persist auth token
  - [x] In `authStore.signup()`: call Firebase `createUserWithEmailAndPassword()`
  - [x] Create User document in Firestore with all required fields
  - [x] Store new user in state
  - [x] In `authStore.logout()`: call Firebase `signOut()` and clear state

- [x] **Task 6: Set Up Protected Routes with Expo Router** (AC: 6)
  - [x] Create `mobile/app/_layout.tsx` (root layout)
  - [x] Check `authStore.isAuthenticated` in root layout
  - [x] Redirect to `/login` if not authenticated
  - [x] Redirect to `/(tabs)` if authenticated
  - [x] Create `mobile/app/(auth)/_layout.tsx` for auth routes
  - [x] Create `mobile/app/(auth)/login.tsx` route
  - [x] Create `mobile/app/(auth)/signup.tsx` route

- [x] **Task 7: Create Placeholder Conversation List Screen** (AC: 6)
  - [x] Create `mobile/app/(tabs)/_layout.tsx` with tab navigation
  - [x] Create `mobile/app/(tabs)/index.tsx` (conversations list placeholder)
  - [x] Show "Welcome, {displayName}!" message
  - [x] Add logout button that calls `authStore.logout()`
  - [x] Verify authenticated user is redirected here after login

## Dev Notes

### Data Models
[Source: docs/architecture.md#data-models]

```typescript
// shared/src/types/models.ts
export interface User {
  id: string;                    // Firebase Auth UID
  email: string;
  displayName: string;
  profilePictureURL: string | null;
  isOnline: boolean;
  lastSeen: Date;
  fcmToken: string | null;       // Will be added in Story 1.9
  createdAt: Date;
}
```

### Firestore Collection Structure
[Source: docs/architecture.md#database-schema]

Collection: `/users/{userId}`
- Document ID = Firebase Auth UID
- Fields: email, displayName, profilePictureURL, isOnline, lastSeen, fcmToken, createdAt

### Zustand Store Pattern
[Source: docs/architecture.md#frontend-architecture]

```typescript
// mobile/src/stores/authStore.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import * as SecureStore from 'expo-secure-store';
import { User } from '@messageai/shared';
import { auth } from '../services/firebase/config';
import { createUserDocument, getUserDocument } from '../services/firestore/usersService';

interface AuthState {
  user: User | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  
  login: (email: string, password: string) => Promise<void>;
  signup: (email: string, password: string, displayName: string) => Promise<void>;
  logout: () => Promise<void>;
  setUser: (user: User | null) => void;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set) => ({
      user: null,
      isAuthenticated: false,
      isLoading: false,
      
      login: async (email, password) => {
        set({ isLoading: true });
        try {
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          const userDoc = await getUserDocument(userCredential.user.uid);
          set({ user: userDoc, isAuthenticated: true, isLoading: false });
        } catch (error) {
          set({ isLoading: false });
          throw error;
        }
      },
      
      signup: async (email, password, displayName) => {
        set({ isLoading: true });
        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const newUser: User = {
            id: userCredential.user.uid,
            email,
            displayName,
            profilePictureURL: null,
            isOnline: true,
            lastSeen: new Date(),
            fcmToken: null,
            createdAt: new Date(),
          };
          await createUserDocument(newUser);
          set({ user: newUser, isAuthenticated: true, isLoading: false });
        } catch (error) {
          set({ isLoading: false });
          throw error;
        }
      },
      
      logout: async () => {
        await signOut(auth);
        set({ user: null, isAuthenticated: false });
      },
      
      setUser: (user) => set({ user, isAuthenticated: !!user }),
    }),
    {
      name: 'auth-storage',
      storage: {
        getItem: async (name) => {
          const value = await SecureStore.getItemAsync(name);
          return value ? JSON.parse(value) : null;
        },
        setItem: async (name, value) => {
          await SecureStore.setItemAsync(name, JSON.stringify(value));
        },
        removeItem: async (name) => {
          await SecureStore.deleteItemAsync(name);
        },
      },
    }
  )
);
```

### Protected Route Pattern
[Source: docs/architecture.md#frontend-architecture]

```typescript
// mobile/src/app/_layout.tsx
import { useEffect } from 'react';
import { Slot, useRouter, useSegments } from 'expo-router';
import { useAuthStore } from '../stores/authStore';

export default function RootLayout() {
  const { isAuthenticated, isLoading } = useAuthStore();
  const segments = useSegments();
  const router = useRouter();
  
  useEffect(() => {
    if (isLoading) return;
    
    const inAuthGroup = segments[0] === '(auth)';
    
    if (!isAuthenticated && !inAuthGroup) {
      router.replace('/login');
    } else if (isAuthenticated && inAuthGroup) {
      router.replace('/');
    }
  }, [isAuthenticated, isLoading, segments]);
  
  if (isLoading) {
    return <LoadingScreen />;
  }
  
  return <Slot />;
}
```

### Error Handling
[Source: docs/architecture.md#frontend-architecture]

Common Firebase Auth error codes to handle:
- `auth/email-already-in-use` - Email exists (signup)
- `auth/invalid-email` - Invalid email format
- `auth/user-not-found` - No account with email (login)
- `auth/wrong-password` - Incorrect password (login)
- `auth/weak-password` - Password < 6 characters (signup)

### Dependencies to Install
- `zustand` - State management
- `expo-secure-store` - Secure token storage
- `react-native-paper` - UI components (TextInput, Button)
- `firebase` - Already installed in Story 1.1

### Testing
[Source: docs/architecture.md#testing-strategy]
- **Manual Testing:** Create account, log in, log out, restart app (verify persistence)
- **Test Scenarios:**
  - Sign up with new email → should succeed
  - Sign up with existing email → should show error
  - Log in with wrong password → should show error
  - Log in successfully → should navigate to conversations list
  - Restart app after login → should stay logged in

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Bob (SM) |
| 2025-10-21 | 1.1 | Implementation complete - All authentication features built and ready for testing | James (Dev) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (Dev Agent - James)

### Debug Log References

No debug logs required. Implementation followed standard patterns with Zustand, Firebase Auth, and Expo Router.

### Completion Notes List

1. **Dependencies Installed**: zustand (v5.0.8), expo-secure-store (v15.0.7), react-native-paper (v5.14.5)
2. **Auth Store**: Zustand store with SecureStore persistence, includes error handling and user-friendly error messages
3. **Firestore Service**: User CRUD operations with serverTimestamp for createdAt/lastSeen fields
4. **Login Screen**: React Native Paper UI with email/password inputs, error handling, loading states
5. **Signup Screen**: Form validation (email format, password length), display name input
6. **Protected Routes**: Root layout with auth state monitoring and automatic redirects between (auth) and (tabs) groups
7. **Conversation List**: Placeholder screen showing user info with logout functionality
8. **Navigation Structure**: Route groups implemented: `(auth)` for login/signup, `(tabs)` for authenticated content

### File List

**Created Files:**
- `mobile/src/stores/authStore.ts` - Zustand auth state management with SecureStore persistence
- `mobile/src/services/firestore/usersService.ts` - Firestore user document operations
- `mobile/src/components/screens/LoginScreen.tsx` - Login UI with React Native Paper
- `mobile/src/components/screens/SignupScreen.tsx` - Signup UI with form validation
- `mobile/app/(auth)/_layout.tsx` - Auth route group layout
- `mobile/app/(auth)/login.tsx` - Login route
- `mobile/app/(auth)/signup.tsx` - Signup route
- `mobile/app/(tabs)/_layout.tsx` - Tabs navigation layout
- `mobile/app/(tabs)/index.tsx` - Conversations placeholder screen

**Modified Files:**
- `mobile/app/_layout.tsx` - Updated with auth redirect logic and PaperProvider
- `mobile/package.json` - Added dependencies (automated)

**Total New Files**: 9 source files created, 1 modified

## QA Results

_To be filled by QA agent_

