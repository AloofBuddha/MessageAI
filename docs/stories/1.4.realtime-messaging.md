# Story 1.4: Real-Time One-on-One Messaging

## Status
**Ready for Review**

## Story

**As a** user,  
**I want** to send and receive text messages in real-time with another user,  
**so that** I can have instant conversations.

## Acceptance Criteria

1. Chat screen displays message history in chronological order with message bubbles
2. Messages show: sender, content, timestamp, delivery status
3. Firestore `messages` collection structure: messageId, conversationId, senderId, content, timestamp, status (sending/sent/delivered/read)
4. Text input field with send button at bottom of screen
5. Real-time Firestore listener updates chat screen when new messages arrive (within 2 seconds)
6. Sent messages appear in chat immediately (optimistic UI - status: sending)
7. Messages are written to Firestore with server timestamp
8. Message status updates from "sending" to "sent" after Firestore confirmation
9. Message bubbles styled differently for sent vs received messages
10. Keyboard behavior: auto-focus input, dismisses on scroll, shows/hides gracefully

## Tasks / Subtasks

- [x] **Task 1: Create Message Data Model** (AC: 3)
  - [x] Add `Message` interface to `shared/src/types/models.ts`
  - [x] Add `MessageStatus` type: 'sending' | 'sent' | 'delivered' | 'read'
  - [x] Add `MessageType` type: 'text' | 'image'
  - [x] Rebuild shared package

- [x] **Task 2: Create Messages Zustand Store** (AC: 5, 6, 8)
  - [x] Create `mobile/src/stores/messagesStore.ts`
  - [x] State: `messagesByConversation: Record<string, Message[]>`
  - [x] Action: `loadMessages(conversationId)` - set up Firestore listener
  - [x] Action: `sendMessage(conversationId, content)` - optimistic add + Firestore write
  - [x] Action: `updateMessageStatus(messageId, status)`

- [x] **Task 3: Create Firestore Messages Service** (AC: 3, 5, 7)
  - [x] Create `mobile/src/services/firestore/messagesService.ts`
  - [x] Implement `listenToMessages(conversationId, callback)` with onSnapshot
  - [x] Implement `sendMessage(message): Promise<void>`
  - [x] Query: `collection('conversations/{id}/messages').orderBy('timestamp', 'asc')`
  - [x] Use `serverTimestamp()` for timestamp field

- [x] **Task 4: Create MessageBubble Component** (AC: 2, 9)
  - [x] Create `mobile/src/components/molecules/MessageBubble.tsx`
  - [x] Props: message, sender, isOwnMessage
  - [x] Display content, timestamp, status icon
  - [x] Style: own messages (blue, align right), other messages (gray, align left)
  - [x] Status icons: ✓ sent, ✓✓ delivered, ✓✓ (blue) read

- [x] **Task 5: Create ChatInput Component** (AC: 4, 10)
  - [x] Create `mobile/src/components/molecules/ChatInput.tsx`
  - [x] TextInput for message content
  - [x] Send IconButton (disabled if empty)
  - [x] Call `messagesStore.sendMessage()` on press
  - [x] Clear input after send
  - [x] KeyboardAvoidingView for iOS/Android

- [x] **Task 6: Create ChatScreen** (AC: 1, 6, 10)
  - [x] Update `mobile/app/chat/[id].tsx`
  - [x] Get conversationId from route params
  - [x] Use `useMessagesStore()` to get messages for conversation
  - [x] Render FlatList of MessageBubble components (inverted for chat UI)
  - [x] Add ChatInput at bottom
  - [x] Auto-scroll to bottom on new message
  - [x] Show loading spinner while messages load

- [x] **Task 7: Implement Optimistic UI** (AC: 6, 8)
  - [x] In `sendMessage()`: generate UUID for `localId`
  - [x] Create Message object with status: 'sending'
  - [x] Add to store immediately (optimistic)
  - [x] Write to Firestore
  - [x] On success: Firestore listener updates with server data
  - [x] On error: Mark message as failed (handle in Story 1.5)

## Dev Notes

### Message Data Model
[Source: docs/architecture.md#data-models]
```typescript
export interface Message {
  id: string;
  conversationId: string;
  senderId: string;
  type: 'text' | 'image';
  content: string;
  imageURL: string | null;
  timestamp: Date;
  status: 'sending' | 'sent' | 'delivered' | 'read';
  deliveredTo: string[];
  readBy: string[];
  localId: string | null;  // Client-side UUID for optimistic UI
}
```

### Firestore Schema
[Source: docs/architecture.md#database-schema]
- Subcollection: `/conversations/{conversationId}/messages/{messageId}`
- Index: `conversationId + timestamp (asc)`

### Optimistic UI Pattern
[Source: docs/architecture.md#architectural-patterns]
```typescript
sendMessage: async (conversationId, content) => {
  const localId = generateUUID();
  const userId = useAuthStore.getState().user!.id;
  
  const message: Message = {
    id: localId,
    conversationId,
    senderId: userId,
    type: 'text',
    content,
    imageURL: null,
    timestamp: new Date(),
    status: 'sending',
    deliveredTo: [],
    readBy: [],
    localId,
  };
  
  // Optimistic update
  set((state) => ({
    messagesByConversation: {
      ...state.messagesByConversation,
      [conversationId]: [...(state.messagesByConversation[conversationId] || []), message]
    }
  }));
  
  // Write to Firestore
  try {
    await messagesService.sendMessage(message);
    // Status will update via Firestore listener
  } catch (error) {
    // Handle in Story 1.5 (offline support)
    console.error('Failed to send message:', error);
  }
}
```

### Chat UI with Inverted FlatList
```typescript
<FlatList
  data={messages}
  renderItem={({ item }) => (
    <MessageBubble 
      message={item} 
      isOwnMessage={item.senderId === currentUserId}
    />
  )}
  inverted  // Latest messages at bottom
  keyExtractor={(item) => item.id}
  onContentSizeChange={() => flatListRef.current?.scrollToEnd()}
/>
```

### KeyboardAvoidingView
```typescript
<KeyboardAvoidingView 
  behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
  style={{ flex: 1 }}
  keyboardVerticalOffset={100}
>
  {/* Chat content */}
</KeyboardAvoidingView>
```

### Real-Time Listener
```typescript
export function listenToMessages(
  conversationId: string,
  callback: (messages: Message[]) => void
): () => void {
  const q = query(
    collection(firestore, `conversations/${conversationId}/messages`),
    orderBy('timestamp', 'asc')
  );
  
  return onSnapshot(q, (snapshot) => {
    const messages = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),
      timestamp: doc.data().timestamp?.toDate() || new Date(),
    })) as Message[];
    callback(messages);
  });
}
```

### Testing
- **Manual:** Send message, see it appear immediately, then update to "sent"
- **Two devices:** Send from device A, verify appears on device B within 2 seconds
- **Rapid fire:** Send 10 messages quickly, verify all appear in order

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Bob (SM) |
| 2025-10-21 | 1.1 | Implementation complete - Real-time messaging with optimistic UI ready for testing | James (Dev) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (Dev Agent - James)

### Debug Log References

No debug logs required. Implementation followed standard real-time messaging patterns.

### Completion Notes List

1. **Message Model**: Already existed in shared types with all required fields including localId for optimistic UI
2. **Firestore Messages Service**: Real-time listener for messages subcollection, sendMessage with serverTimestamp, updateMessageStatus for read receipts
3. **Messages Zustand Store**: State management by conversation, optimistic UI with UUID generation, proper cleanup on unmount
4. **MessageBubble Component**: WhatsApp-style bubbles with different colors for sent/received, status icons (sending/sent/delivered/read/failed)
5. **ChatInput Component**: Multiline text input with send button, auto-clear on send, disabled state support
6. **ChatScreen**: Inverted FlatList for chat UI, auto-scroll on new messages, KeyboardAvoidingView for iOS/Android, empty state
7. **Optimistic UI**: Messages appear instantly with "sending" status, update to "sent" when Firestore confirms, mark as "failed" on error

### File List

**Created Files:**
- `mobile/src/services/firestore/messagesService.ts` - Real-time messages queries and mutations
- `mobile/src/stores/messagesStore.ts` - Zustand store with optimistic UI pattern
- `mobile/src/components/molecules/MessageBubble.tsx` - Message bubble component with status indicators
- `mobile/src/components/molecules/ChatInput.tsx` - Text input component with send button

**Modified Files:**
- `mobile/app/chat/[id].tsx` - Replaced placeholder with full messaging UI
- `shared/src/types/models.ts` - Message model already existed

**Total New Files**: 4 source files created, 1 modified

## QA Results

_To be filled by QA agent_

