# Story 1.4: Real-Time One-on-One Messaging

## Status
**Draft**

## Story

**As a** user,  
**I want** to send and receive text messages in real-time with another user,  
**so that** I can have instant conversations.

## Acceptance Criteria

1. Chat screen displays message history in chronological order with message bubbles
2. Messages show: sender, content, timestamp, delivery status
3. Firestore `messages` collection structure: messageId, conversationId, senderId, content, timestamp, status (sending/sent/delivered/read)
4. Text input field with send button at bottom of screen
5. Real-time Firestore listener updates chat screen when new messages arrive (within 2 seconds)
6. Sent messages appear in chat immediately (optimistic UI - status: sending)
7. Messages are written to Firestore with server timestamp
8. Message status updates from "sending" to "sent" after Firestore confirmation
9. Message bubbles styled differently for sent vs received messages
10. Keyboard behavior: auto-focus input, dismisses on scroll, shows/hides gracefully

## Tasks / Subtasks

- [ ] **Task 1: Create Message Data Model** (AC: 3)
  - [ ] Add `Message` interface to `shared/src/types/models.ts`
  - [ ] Add `MessageStatus` type: 'sending' | 'sent' | 'delivered' | 'read'
  - [ ] Add `MessageType` type: 'text' | 'image'
  - [ ] Rebuild shared package

- [ ] **Task 2: Create Messages Zustand Store** (AC: 5, 6, 8)
  - [ ] Create `mobile/src/stores/messagesStore.ts`
  - [ ] State: `messagesByConversation: Record<string, Message[]>`
  - [ ] Action: `loadMessages(conversationId)` - set up Firestore listener
  - [ ] Action: `sendMessage(conversationId, content)` - optimistic add + Firestore write
  - [ ] Action: `updateMessageStatus(messageId, status)`

- [ ] **Task 3: Create Firestore Messages Service** (AC: 3, 5, 7)
  - [ ] Create `mobile/src/services/firestore/messagesService.ts`
  - [ ] Implement `listenToMessages(conversationId, callback)` with onSnapshot
  - [ ] Implement `sendMessage(message): Promise<void>`
  - [ ] Query: `collection('conversations/{id}/messages').orderBy('timestamp', 'asc')`
  - [ ] Use `serverTimestamp()` for timestamp field

- [ ] **Task 4: Create MessageBubble Component** (AC: 2, 9)
  - [ ] Create `mobile/src/components/molecules/MessageBubble.tsx`
  - [ ] Props: message, sender, isOwnMessage
  - [ ] Display content, timestamp, status icon
  - [ ] Style: own messages (blue, align right), other messages (gray, align left)
  - [ ] Status icons: ✓ sent, ✓✓ delivered, ✓✓ (blue) read

- [ ] **Task 5: Create ChatInput Component** (AC: 4, 10)
  - [ ] Create `mobile/src/components/molecules/ChatInput.tsx`
  - [ ] TextInput for message content
  - [ ] Send IconButton (disabled if empty)
  - [ ] Call `messagesStore.sendMessage()` on press
  - [ ] Clear input after send
  - [ ] KeyboardAvoidingView for iOS/Android

- [ ] **Task 6: Create ChatScreen** (AC: 1, 6, 10)
  - [ ] Update `mobile/src/app/chat/[id].tsx`
  - [ ] Get conversationId from route params
  - [ ] Use `useMessagesStore()` to get messages for conversation
  - [ ] Render FlatList of MessageBubble components (inverted for chat UI)
  - [ ] Add ChatInput at bottom
  - [ ] Auto-scroll to bottom on new message
  - [ ] Show loading spinner while messages load

- [ ] **Task 7: Implement Optimistic UI** (AC: 6, 8)
  - [ ] In `sendMessage()`: generate UUID for `localId`
  - [ ] Create Message object with status: 'sending'
  - [ ] Add to store immediately (optimistic)
  - [ ] Write to Firestore
  - [ ] On success: Firestore listener updates with server data
  - [ ] On error: Mark message as failed (handle in Story 1.5)

## Dev Notes

### Message Data Model
[Source: docs/architecture.md#data-models]
```typescript
export interface Message {
  id: string;
  conversationId: string;
  senderId: string;
  type: 'text' | 'image';
  content: string;
  imageURL: string | null;
  timestamp: Date;
  status: 'sending' | 'sent' | 'delivered' | 'read';
  deliveredTo: string[];
  readBy: string[];
  localId: string | null;  // Client-side UUID for optimistic UI
}
```

### Firestore Schema
[Source: docs/architecture.md#database-schema]
- Subcollection: `/conversations/{conversationId}/messages/{messageId}`
- Index: `conversationId + timestamp (asc)`

### Optimistic UI Pattern
[Source: docs/architecture.md#architectural-patterns]
```typescript
sendMessage: async (conversationId, content) => {
  const localId = generateUUID();
  const userId = useAuthStore.getState().user!.id;
  
  const message: Message = {
    id: localId,
    conversationId,
    senderId: userId,
    type: 'text',
    content,
    imageURL: null,
    timestamp: new Date(),
    status: 'sending',
    deliveredTo: [],
    readBy: [],
    localId,
  };
  
  // Optimistic update
  set((state) => ({
    messagesByConversation: {
      ...state.messagesByConversation,
      [conversationId]: [...(state.messagesByConversation[conversationId] || []), message]
    }
  }));
  
  // Write to Firestore
  try {
    await messagesService.sendMessage(message);
    // Status will update via Firestore listener
  } catch (error) {
    // Handle in Story 1.5 (offline support)
    console.error('Failed to send message:', error);
  }
}
```

### Chat UI with Inverted FlatList
```typescript
<FlatList
  data={messages}
  renderItem={({ item }) => (
    <MessageBubble 
      message={item} 
      isOwnMessage={item.senderId === currentUserId}
    />
  )}
  inverted  // Latest messages at bottom
  keyExtractor={(item) => item.id}
  onContentSizeChange={() => flatListRef.current?.scrollToEnd()}
/>
```

### KeyboardAvoidingView
```typescript
<KeyboardAvoidingView 
  behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
  style={{ flex: 1 }}
  keyboardVerticalOffset={100}
>
  {/* Chat content */}
</KeyboardAvoidingView>
```

### Real-Time Listener
```typescript
export function listenToMessages(
  conversationId: string,
  callback: (messages: Message[]) => void
): () => void {
  const q = query(
    collection(firestore, `conversations/${conversationId}/messages`),
    orderBy('timestamp', 'asc')
  );
  
  return onSnapshot(q, (snapshot) => {
    const messages = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),
      timestamp: doc.data().timestamp?.toDate() || new Date(),
    })) as Message[];
    callback(messages);
  });
}
```

### Testing
- **Manual:** Send message, see it appear immediately, then update to "sent"
- **Two devices:** Send from device A, verify appears on device B within 2 seconds
- **Rapid fire:** Send 10 messages quickly, verify all appear in order

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

_To be filled by dev agent_

## QA Results

_To be filled by QA agent_

