# Story 1.9: Push Notifications

## Status
**Draft**

## Story

**As a** user,  
**I want** to receive push notifications for new messages,  
**so that** I don't miss important conversations when the app is backgrounded.

## Acceptance Criteria

1. Expo Notifications configured with FCM credentials
2. User's FCM device token stored in Firestore `users` collection on login
3. Cloud Function trigger: when new message written to Firestore, send push notification to recipient's device token
4. Notification payload includes: sender name, message preview, conversationId for deep linking
5. Foreground notifications shown with banner (minimum requirement for MVP)
6. Background notifications shown in system tray (iOS/Android notification center)
7. Tapping notification opens app to the specific conversation
8. Notifications respect system permissions (request permission on first launch)
9. Group messages send notifications to all participants except sender
10. Basic notification throttling to prevent spam (max 1 notification per conversation per 5 seconds)

## Tasks / Subtasks

- [ ] **Task 1: Install and Configure Expo Notifications** (AC: 1, 8)
  - [ ] Install: `npx expo install expo-notifications expo-device expo-constants`
  - [ ] Configure `app.json` with FCM credentials
  - [ ] Request notification permissions on app launch
  - [ ] Handle Android notification channels

- [ ] **Task 2: Register Device Token** (AC: 2)
  - [ ] Create `mobile/src/services/notifications/notificationService.ts`
  - [ ] Implement `registerForPushNotifications(): Promise<string>`
  - [ ] Get Expo Push Token
  - [ ] Call in `authStore.login()` and store in Firestore `users/{userId}.fcmToken`

- [ ] **Task 3: Create Cloud Function for Message Notifications** (AC: 3, 4, 9, 10)
  - [ ] Create `functions/src/triggers/onMessageCreated.ts`
  - [ ] Firestore trigger: `onCreate` on `/conversations/{id}/messages/{messageId}`
  - [ ] Get conversation participants (exclude sender)
  - [ ] Fetch recipient FCM tokens from users collection
  - [ ] Build notification payload: title = sender name, body = message content
  - [ ] Send via Expo Push Notification API
  - [ ] Add throttling: check if notification sent to conversation in last 5 seconds

- [ ] **Task 4: Handle Foreground Notifications** (AC: 5)
  - [ ] Configure `Notifications.setNotificationHandler()`
  - [ ] Show banner with sender name and message preview
  - [ ] Auto-dismiss after 3 seconds
  - [ ] Don't show notification if user is already in that conversation

- [ ] **Task 5: Handle Background Notifications** (AC: 6)
  - [ ] Default behavior: notifications appear in system tray
  - [ ] Ensure notification channel is configured for Android
  - [ ] Test on physical device (Expo Go has limitations)

- [ ] **Task 6: Implement Deep Linking** (AC: 7)
  - [ ] Add notification data: `{ conversationId: '...' }`
  - [ ] Configure Expo Router for deep links
  - [ ] Listen to `Notifications.addNotificationResponseReceivedListener()`
  - [ ] Navigate to `/chat/[id]` when notification tapped

- [ ] **Task 7: Add Notification Throttling** (AC: 10)
  - [ ] Create `/notifications_throttle/{conversationId}` collection in Firestore
  - [ ] Before sending notification: check if doc exists with timestamp < 5 seconds ago
  - [ ] If exists: skip notification
  - [ ] If not: send notification and create throttle doc with TTL

- [ ] **Task 8: Deploy Cloud Function** (AC: 3)
  - [ ] Test function locally with Firebase Emulators
  - [ ] Deploy: `firebase deploy --only functions`
  - [ ] Test with real devices

## Dev Notes

### Expo Notifications Setup
[Source: docs/architecture.md#tech-stack]

```typescript
// notificationService.ts
import * as Notifications from 'expo-notifications';
import * as Device from 'expo-device';
import Constants from 'expo-constants';

export async function registerForPushNotifications(): Promise<string | null> {
  if (!Device.isDevice) {
    console.log('Push notifications only work on physical devices');
    return null;
  }
  
  // Request permissions
  const { status: existingStatus } = await Notifications.getPermissionsAsync();
  let finalStatus = existingStatus;
  
  if (existingStatus !== 'granted') {
    const { status } = await Notifications.requestPermissionsAsync();
    finalStatus = status;
  }
  
  if (finalStatus !== 'granted') {
    console.log('Failed to get push token for push notification!');
    return null;
  }
  
  // Get Expo Push Token
  const token = await Notifications.getExpoPushTokenAsync({
    projectId: Constants.expoConfig?.extra?.eas?.projectId,
  });
  
  // Configure Android notification channel
  if (Platform.OS === 'android') {
    await Notifications.setNotificationChannelAsync('default', {
      name: 'default',
      importance: Notifications.AndroidImportance.MAX,
      vibrationPattern: [0, 250, 250, 250],
      lightColor: '#FF231F7C',
    });
  }
  
  return token.data;
}
```

### Store FCM Token on Login
```typescript
// In authStore.login()
const fcmToken = await registerForPushNotifications();
if (fcmToken) {
  await updateDoc(doc(firestore, 'users', userId), {
    fcmToken,
  });
}
```

### Cloud Function: Send Notification
[Source: docs/architecture.md#backend-architecture]

```typescript
// functions/src/triggers/onMessageCreated.ts
import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';

export const onMessageCreated = functions.firestore
  .document('conversations/{conversationId}/messages/{messageId}')
  .onCreate(async (snapshot, context) => {
    const message = snapshot.data();
    const { conversationId } = context.params;
    
    // Get conversation to find participants
    const conversationDoc = await admin.firestore()
      .doc(`conversations/${conversationId}`)
      .get();
    const conversation = conversationDoc.data();
    
    if (!conversation) return;
    
    // Get sender info
    const senderDoc = await admin.firestore()
      .doc(`users/${message.senderId}`)
      .get();
    const sender = senderDoc.data();
    
    // Find recipients (exclude sender)
    const recipientIds = conversation.participants.filter(
      (id: string) => id !== message.senderId
    );
    
    // Check throttle
    const throttleDoc = await admin.firestore()
      .doc(`notifications_throttle/${conversationId}`)
      .get();
    
    if (throttleDoc.exists) {
      const lastSent = throttleDoc.data()?.lastSentAt?.toMillis() || 0;
      const now = Date.now();
      if (now - lastSent < 5000) {
        console.log('Throttled notification for conversation:', conversationId);
        return;
      }
    }
    
    // Get recipient tokens
    const usersSnapshot = await admin.firestore()
      .collection('users')
      .where(admin.firestore.FieldPath.documentId(), 'in', recipientIds)
      .get();
    
    const tokens = usersSnapshot.docs
      .map(doc => doc.data().fcmToken)
      .filter(token => !!token);
    
    if (tokens.length === 0) return;
    
    // Send push notifications via Expo
    const messages = tokens.map(token => ({
      to: token,
      sound: 'default',
      title: sender?.displayName || 'New Message',
      body: message.type === 'text' ? message.content : 'ðŸ“· Image',
      data: { conversationId },
    }));
    
    await fetch('https://exp.host/--/api/v2/push/send', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(messages),
    });
    
    // Set throttle doc with TTL
    await admin.firestore()
      .doc(`notifications_throttle/${conversationId}`)
      .set({
        lastSentAt: admin.firestore.FieldValue.serverTimestamp(),
      });
  });
```

### Handle Foreground Notifications
```typescript
// In App.tsx or root layout
Notifications.setNotificationHandler({
  handleNotification: async (notification) => {
    // Check if user is in the conversation
    const conversationId = notification.request.content.data.conversationId;
    const currentRoute = getCurrentRoute();  // Get from navigation state
    
    if (currentRoute === `/chat/${conversationId}`) {
      // User is already viewing this conversation - don't show notification
      return {
        shouldShowAlert: false,
        shouldPlaySound: false,
        shouldSetBadge: false,
      };
    }
    
    return {
      shouldShowAlert: true,
      shouldPlaySound: true,
      shouldSetBadge: true,
    };
  },
});
```

### Handle Deep Linking
```typescript
// In root _layout.tsx
useEffect(() => {
  const subscription = Notifications.addNotificationResponseReceivedListener(
    (response) => {
      const conversationId = response.notification.request.content.data.conversationId;
      if (conversationId) {
        router.push(`/chat/${conversationId}`);
      }
    }
  );
  
  return () => subscription.remove();
}, []);
```

### app.json Configuration
```json
{
  "expo": {
    "plugins": [
      [
        "expo-notifications",
        {
          "icon": "./assets/notification-icon.png",
          "color": "#ffffff",
          "sounds": ["./assets/notification-sound.wav"]
        }
      ]
    ],
    "android": {
      "googleServicesFile": "./google-services.json"
    },
    "ios": {
      "googleServicesFile": "./GoogleService-Info.plist"
    }
  }
}
```

### Testing
- **Permissions:** First launch, verify permission prompt appears
- **Foreground:** Send message from device A while B has app open, verify banner appears
- **Background:** Send message from A while B app is backgrounded, verify system notification
- **Deep link:** Tap notification, verify app opens to correct conversation
- **Throttle:** Send 5 messages rapidly, verify only 1 notification sent
- **Groups:** Send group message, verify all participants (except sender) receive notification

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

_To be filled by dev agent_

## QA Results

_To be filled by QA agent_

