# Story 1.3: Conversation List & Basic UI

## Status
**Ready for Review**

## Story

**As a** user,  
**I want** to see a list of my conversations with latest message previews,  
**so that** I can navigate to chats I care about.

## Acceptance Criteria

1. Conversation list screen displays all conversations for the authenticated user
2. Each conversation shows: contact name/group name, latest message preview, timestamp, unread indicator
3. Firestore `conversations` collection structure: conversationId, participants[], lastMessage, lastMessageTimestamp, type (direct/group)
4. Real-time Firestore listener updates conversation list when new messages arrive
5. Tapping a conversation navigates to chat screen with conversation context
6. Empty state shown when user has no conversations
7. New conversation button/action available (can be placeholder for now)
8. Basic styling follows messaging app conventions (similar to WhatsApp layout)

## Tasks / Subtasks

- [x] **Task 1: Create Conversation Data Model** (AC: 3)
  - [x] Add `Conversation` interface to `shared/src/types/models.ts`
  - [x] Include fields: id, type, name, participants, lastMessage, lastMessageTimestamp, groupPictureURL, createdAt, createdBy
  - [x] Rebuild shared package

- [x] **Task 2: Create Conversations Zustand Store** (AC: 1, 4)
  - [x] Create `mobile/src/stores/conversationsStore.ts`
  - [x] Define state: conversations[], isLoading
  - [x] Implement actions: loadConversations(), createConversation()
  - [x] Set up real-time Firestore listener in loadConversations()

- [x] **Task 3: Create Firestore Conversations Service** (AC: 3, 4)
  - [x] Create `mobile/src/services/firestore/conversationsService.ts`
  - [x] Implement `getUserConversations(userId): Observable<Conversation[]>` with onSnapshot
  - [x] Implement `createConversation(participants, type, name?): Promise<string>`
  - [x] Query: `where('participants', 'array-contains', userId).orderBy('lastMessageTimestamp', 'desc')`

- [x] **Task 4: Create ConversationListItem Component** (AC: 2, 8)
  - [x] Create `mobile/src/components/molecules/ConversationListItem.tsx`
  - [x] Display contact/group name, last message preview (truncated to 50 chars)
  - [x] Show timestamp (formatted: "2m ago", "Yesterday", "Oct 19")
  - [x] Add unread indicator badge (placeholder count for now)
  - [x] Style with React Native Paper Card/List.Item
  - [x] Add onPress handler to navigate to chat

- [x] **Task 5: Create ConversationsList Screen** (AC: 1, 5, 6, 7, 8)
  - [x] Update `mobile/app/(tabs)/index.tsx` to be conversations list
  - [x] Use `useConversationsStore()` to get conversations
  - [x] Render FlatList of ConversationListItem components
  - [x] Show empty state: "No conversations yet. Start chatting!"
  - [x] Add FAB (Floating Action Button) for new conversation (placeholder for now)
  - [x] Handle navigation to `/chat/[id]` on tap

- [x] **Task 6: Create Placeholder Chat Screen Route** (AC: 5)
  - [x] Create `mobile/app/chat/[id].tsx` dynamic route
  - [x] Extract conversation ID from route params
  - [x] Show "Chat with {conversationId}" placeholder text
  - [x] Add back button to return to conversations list

## Dev Notes

### Data Model
[Source: docs/architecture.md#data-models]
```typescript
export interface Conversation {
  id: string;
  type: 'direct' | 'group';
  name: string | null;           // Group name (null for direct)
  participants: string[];         // User IDs
  lastMessage: string | null;     // Preview text
  lastMessageTimestamp: Date | null;
  groupPictureURL: string | null;
  createdAt: Date;
  createdBy: string;              // User ID
}
```

### Firestore Schema
[Source: docs/architecture.md#database-schema]
- Collection: `/conversations/{conversationId}`
- Index needed: `participants (array-contains) + lastMessageTimestamp (desc)`
  - Create in Firebase Console or `firestore.indexes.json`

### Real-Time Listener Pattern
[Source: docs/architecture.md#frontend-architecture]
```typescript
// In conversationsService.ts
import { collection, query, where, orderBy, onSnapshot } from 'firebase/firestore';

export function listenToUserConversations(
  userId: string, 
  callback: (conversations: Conversation[]) => void
): () => void {
  const q = query(
    collection(firestore, 'conversations'),
    where('participants', 'array-contains', userId),
    orderBy('lastMessageTimestamp', 'desc')
  );
  
  return onSnapshot(q, (snapshot) => {
    const conversations = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),
      createdAt: doc.data().createdAt.toDate(),
      lastMessageTimestamp: doc.data().lastMessageTimestamp?.toDate() || null,
    })) as Conversation[];
    callback(conversations);
  });
}
```

### Zustand Store with Listener
```typescript
// conversationsStore.ts
export const useConversationsStore = create<ConversationsState>((set, get) => ({
  conversations: [],
  isLoading: false,
  unsubscribe: null,
  
  loadConversations: (userId: string) => {
    set({ isLoading: true });
    
    // Clean up previous listener
    const prevUnsub = get().unsubscribe;
    if (prevUnsub) prevUnsub();
    
    // Set up new listener
    const unsubscribe = listenToUserConversations(userId, (conversations) => {
      set({ conversations, isLoading: false });
    });
    
    set({ unsubscribe });
  },
}));
```

### Date Formatting Utility
Create `mobile/src/utils/dateFormatter.ts`:
```typescript
export function formatTimestamp(date: Date): string {
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return date.toLocaleDateString('en', { weekday: 'short' });
  return date.toLocaleDateString('en', { month: 'short', day: 'numeric' });
}
```

### Empty State Design
[Source: docs/architecture.md#ui-design-goals]
- Center-aligned text: "No conversations yet"
- Subtitle: "Start a new conversation to get started"
- Icon: Chat bubble icon from MaterialCommunityIcons

### Testing
- **Manual:** Create test conversation in Firestore console, verify it appears in list
- **Real-time:** Update lastMessage in console, verify list updates automatically
- **Navigation:** Tap conversation, verify route to `/chat/[id]`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Bob (SM) |
| 2025-10-21 | 1.1 | Implementation complete - Conversation list with real-time updates ready for testing | James (Dev) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (Dev Agent - James)

### Debug Log References

No debug logs required. Implementation followed standard Firestore real-time listener patterns.

### Completion Notes List

1. **Conversation Model**: Already existed in shared types package, rebuilt successfully
2. **Date Formatter Utility**: Created with multiple formats (timestamp, message time, date header)
3. **Firestore Service**: Real-time listener with onSnapshot, createConversation function, display name helper
4. **Conversations Store**: Zustand store with real-time updates, proper cleanup of listeners
5. **ConversationListItem Component**: WhatsApp-style UI with avatar, name, last message preview, timestamp, unread badge
6. **Conversations List Screen**: FlatList with empty state, loading state, FAB for new conversations
7. **Chat Screen**: Placeholder dynamic route `/chat/[id]` for navigation testing
8. **Important Note**: Firestore index required: `participants (array-contains) + lastMessageTimestamp (desc)` - must be created in Firebase Console

### File List

**Created Files:**
- `mobile/src/utils/dateFormatter.ts` - Date formatting utilities for conversation list
- `mobile/src/services/firestore/conversationsService.ts` - Real-time conversation queries and mutations
- `mobile/src/stores/conversationsStore.ts` - Zustand store for conversation state with real-time listener
- `mobile/src/components/molecules/ConversationListItem.tsx` - Conversation list item component
- `mobile/app/chat/[id].tsx` - Placeholder chat screen with dynamic routing

**Modified Files:**
- `mobile/app/(tabs)/index.tsx` - Replaced placeholder with full conversation list implementation
- `shared/src/types/models.ts` - Conversation model already existed

**Total New Files**: 5 source files created, 1 modified

## QA Results

_To be filled by QA agent_

