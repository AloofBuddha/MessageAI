# Story 1.3: Conversation List & Basic UI

## Status
**Draft**

## Story

**As a** user,  
**I want** to see a list of my conversations with latest message previews,  
**so that** I can navigate to chats I care about.

## Acceptance Criteria

1. Conversation list screen displays all conversations for the authenticated user
2. Each conversation shows: contact name/group name, latest message preview, timestamp, unread indicator
3. Firestore `conversations` collection structure: conversationId, participants[], lastMessage, lastMessageTimestamp, type (direct/group)
4. Real-time Firestore listener updates conversation list when new messages arrive
5. Tapping a conversation navigates to chat screen with conversation context
6. Empty state shown when user has no conversations
7. New conversation button/action available (can be placeholder for now)
8. Basic styling follows messaging app conventions (similar to WhatsApp layout)

## Tasks / Subtasks

- [ ] **Task 1: Create Conversation Data Model** (AC: 3)
  - [ ] Add `Conversation` interface to `shared/src/types/models.ts`
  - [ ] Include fields: id, type, name, participants, lastMessage, lastMessageTimestamp, groupPictureURL, createdAt, createdBy
  - [ ] Rebuild shared package

- [ ] **Task 2: Create Conversations Zustand Store** (AC: 1, 4)
  - [ ] Create `mobile/src/stores/conversationsStore.ts`
  - [ ] Define state: conversations[], isLoading
  - [ ] Implement actions: loadConversations(), createConversation()
  - [ ] Set up real-time Firestore listener in loadConversations()

- [ ] **Task 3: Create Firestore Conversations Service** (AC: 3, 4)
  - [ ] Create `mobile/src/services/firestore/conversationsService.ts`
  - [ ] Implement `getUserConversations(userId): Observable<Conversation[]>` with onSnapshot
  - [ ] Implement `createConversation(participants, type, name?): Promise<string>`
  - [ ] Query: `where('participants', 'array-contains', userId).orderBy('lastMessageTimestamp', 'desc')`

- [ ] **Task 4: Create ConversationListItem Component** (AC: 2, 8)
  - [ ] Create `mobile/src/components/molecules/ConversationListItem.tsx`
  - [ ] Display contact/group name, last message preview (truncated to 50 chars)
  - [ ] Show timestamp (formatted: "2m ago", "Yesterday", "Oct 19")
  - [ ] Add unread indicator badge (placeholder count for now)
  - [ ] Style with React Native Paper Card/List.Item
  - [ ] Add onPress handler to navigate to chat

- [ ] **Task 5: Create ConversationsList Screen** (AC: 1, 5, 6, 7, 8)
  - [ ] Update `mobile/src/app/(tabs)/index.tsx` to be conversations list
  - [ ] Use `useConversationsStore()` to get conversations
  - [ ] Render FlatList of ConversationListItem components
  - [ ] Show empty state: "No conversations yet. Start chatting!"
  - [ ] Add FAB (Floating Action Button) for new conversation (placeholder for now)
  - [ ] Handle navigation to `/chat/[id]` on tap

- [ ] **Task 6: Create Placeholder Chat Screen Route** (AC: 5)
  - [ ] Create `mobile/src/app/chat/[id].tsx` dynamic route
  - [ ] Extract conversation ID from route params
  - [ ] Show "Chat with {conversationId}" placeholder text
  - [ ] Add back button to return to conversations list

## Dev Notes

### Data Model
[Source: docs/architecture.md#data-models]
```typescript
export interface Conversation {
  id: string;
  type: 'direct' | 'group';
  name: string | null;           // Group name (null for direct)
  participants: string[];         // User IDs
  lastMessage: string | null;     // Preview text
  lastMessageTimestamp: Date | null;
  groupPictureURL: string | null;
  createdAt: Date;
  createdBy: string;              // User ID
}
```

### Firestore Schema
[Source: docs/architecture.md#database-schema]
- Collection: `/conversations/{conversationId}`
- Index needed: `participants (array-contains) + lastMessageTimestamp (desc)`
  - Create in Firebase Console or `firestore.indexes.json`

### Real-Time Listener Pattern
[Source: docs/architecture.md#frontend-architecture]
```typescript
// In conversationsService.ts
import { collection, query, where, orderBy, onSnapshot } from 'firebase/firestore';

export function listenToUserConversations(
  userId: string, 
  callback: (conversations: Conversation[]) => void
): () => void {
  const q = query(
    collection(firestore, 'conversations'),
    where('participants', 'array-contains', userId),
    orderBy('lastMessageTimestamp', 'desc')
  );
  
  return onSnapshot(q, (snapshot) => {
    const conversations = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),
      createdAt: doc.data().createdAt.toDate(),
      lastMessageTimestamp: doc.data().lastMessageTimestamp?.toDate() || null,
    })) as Conversation[];
    callback(conversations);
  });
}
```

### Zustand Store with Listener
```typescript
// conversationsStore.ts
export const useConversationsStore = create<ConversationsState>((set, get) => ({
  conversations: [],
  isLoading: false,
  unsubscribe: null,
  
  loadConversations: (userId: string) => {
    set({ isLoading: true });
    
    // Clean up previous listener
    const prevUnsub = get().unsubscribe;
    if (prevUnsub) prevUnsub();
    
    // Set up new listener
    const unsubscribe = listenToUserConversations(userId, (conversations) => {
      set({ conversations, isLoading: false });
    });
    
    set({ unsubscribe });
  },
}));
```

### Date Formatting Utility
Create `mobile/src/utils/dateFormatter.ts`:
```typescript
export function formatTimestamp(date: Date): string {
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return date.toLocaleDateString('en', { weekday: 'short' });
  return date.toLocaleDateString('en', { month: 'short', day: 'numeric' });
}
```

### Empty State Design
[Source: docs/architecture.md#ui-design-goals]
- Center-aligned text: "No conversations yet"
- Subtitle: "Start a new conversation to get started"
- Icon: Chat bubble icon from MaterialCommunityIcons

### Testing
- **Manual:** Create test conversation in Firestore console, verify it appears in list
- **Real-time:** Update lastMessage in console, verify list updates automatically
- **Navigation:** Tap conversation, verify route to `/chat/[id]`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

_To be filled by dev agent_

## QA Results

_To be filled by QA agent_

