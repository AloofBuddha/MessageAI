# Story 1.11: MVP Testing & Polish

## Status
**Draft**

## Story

**As a** developer,  
**I want** to verify all MVP requirements work end-to-end with edge case handling,  
**so that** the app passes the 24-hour gate with confidence.

## Acceptance Criteria

1. Two-device testing completed: messages send/receive in real-time between devices
2. Offline scenario tested: go offline, send messages, come online, messages deliver
3. Background scenario tested: receive message while app backgrounded, notification appears
4. Force quit scenario tested: force quit app mid-send, message delivers on relaunch
5. Poor network tested: throttle connection, messages eventually deliver with status updates
6. Rapid-fire tested: send 20+ messages quickly, all deliver in order
7. Group chat tested: 3+ participants send messages, all receive with correct attribution
8. App lifecycle tested: background → foreground transitions preserve state
9. Basic error handling added: network errors show user-friendly messages with retry
10. MVP demo script prepared: 5-minute walkthrough showing all FR1-FR11 working

## Tasks / Subtasks

- [ ] **Task 1: Set Up Testing Environment** (AC: 1)
  - [ ] Build app on 2 physical devices (iOS/Android)
  - [ ] Create 3 test accounts: alice@test.com, bob@test.com, charlie@test.com
  - [ ] Log in to different accounts on each device
  - [ ] Ensure Firebase and Push Notifications are configured

- [ ] **Task 2: Test Core Messaging Flow** (AC: 1, 6)
  - [ ] Device A (Alice): Send message to Bob
  - [ ] Device B (Bob): Verify message arrives within 2 seconds
  - [ ] Device B: Reply to Alice
  - [ ] Device A: Verify reply arrives
  - [ ] Send 20 messages rapidly from A → B
  - [ ] Verify all messages arrive in correct order with no duplicates

- [ ] **Task 3: Test Offline Support** (AC: 2, 4)
  - [ ] Device A: Enable airplane mode
  - [ ] Device A: Send 3 messages (should queue)
  - [ ] Verify messages show "sending" status
  - [ ] Device A: Disable airplane mode
  - [ ] Verify messages sync to Firestore and status updates to "sent"
  - [ ] Device A: Send message, immediately force quit app mid-upload
  - [ ] Reopen app, verify message sends on relaunch

- [ ] **Task 4: Test Push Notifications** (AC: 3)
  - [ ] Device B: Background the app (Home button)
  - [ ] Device A: Send message to Bob
  - [ ] Device B: Verify system notification appears
  - [ ] Device B: Tap notification
  - [ ] Verify app opens to correct conversation

- [ ] **Task 5: Test Poor Network Conditions** (AC: 5)
  - [ ] Use Network Link Conditioner (iOS) or Android network throttling
  - [ ] Set to "3G" or "Edge" speed
  - [ ] Send message from Device A
  - [ ] Verify status shows "sending" → eventually "sent" (may take 10-30 seconds)
  - [ ] Verify no crashes or UI freezes

- [ ] **Task 6: Test Group Chat** (AC: 7)
  - [ ] Device A (Alice): Create group "Test Team" with Bob and Charlie
  - [ ] Verify group appears on Device B and Device C
  - [ ] Device A: Send message in group
  - [ ] Verify Device B and C receive message with sender name
  - [ ] Device B: Reply in group
  - [ ] Verify all devices show reply with correct attribution
  - [ ] Device C: Check read receipts show "Read by 2" on Device A

- [ ] **Task 7: Test App Lifecycle** (AC: 8)
  - [ ] Device A: Open chat with Bob
  - [ ] Background app for 5 minutes
  - [ ] Device B: Send 3 messages
  - [ ] Device A: Foreground app
  - [ ] Verify messages appear immediately, presence updates to "online"
  - [ ] Verify typing indicator works after backgrounding

- [ ] **Task 8: Add Error Handling UI** (AC: 9)
  - [ ] Create `mobile/src/components/molecules/ErrorBanner.tsx`
  - [ ] Show user-friendly error messages for common failures:
    - "Message failed to send. Tap to retry."
    - "Connection lost. Messages will send when back online."
    - "Failed to load messages. Pull to refresh."
  - [ ] Add retry buttons for failed operations
  - [ ] Test: Disconnect mid-send, verify error banner appears, tap retry, verify sends

- [ ] **Task 9: Performance & Polish** (AC: 10)
  - [ ] Add loading spinners for: login, conversations list, chat messages
  - [ ] Add pull-to-refresh on conversations list
  - [ ] Add empty states with friendly messages
  - [ ] Fix any UI jank: optimize FlatList with `windowSize`, `removeClippedSubviews`
  - [ ] Ensure keyboard behavior is smooth (no overlaps)
  - [ ] Add haptic feedback on message send

- [ ] **Task 10: Create MVP Demo Script** (AC: 10)
  - [ ] Write `docs/mvp-demo-script.md`
  - [ ] Script covers:
    1. Sign up & login (FR1)
    2. Send 1-on-1 message (FR2, FR3, FR4)
    3. Offline support: send message offline, show it syncs (FR5)
    4. Optimistic UI: show instant message appearance (FR6)
    5. Presence: show online/offline indicator (FR8)
    6. Read receipts: show status progression (FR9)
    7. Group chat: create group, send message (FR10)
    8. Push notification: background app, receive notification (FR11)
    9. Profile picture: show avatar in conversation list (FR11)
  - [ ] Record 5-minute demo video (optional but recommended)

- [ ] **Task 11: Fix Critical Bugs** (AC: 1-9)
  - [ ] Review Firebase Console logs for errors
  - [ ] Check Expo logs for crashes
  - [ ] Fix any crashes found during testing
  - [ ] Ensure no data loss scenarios

- [ ] **Task 12: Final Checklist Review** (AC: 10)
  - [ ] ✅ FR1: Authentication works (sign up, login, logout)
  - [ ] ✅ FR2: 1-on-1 messaging works in real-time
  - [ ] ✅ FR3: Messages persist locally (SQLite)
  - [ ] ✅ FR4: Optimistic UI works (instant message display)
  - [ ] ✅ FR5: Offline support works (queue, sync on reconnect)
  - [ ] ✅ FR6: Presence indicators work (online/offline)
  - [ ] ✅ FR7: Timestamps display correctly
  - [ ] ✅ FR8: Group chat works (3+ participants)
  - [ ] ✅ FR9: Read receipts work (status updates)
  - [ ] ✅ FR10: Push notifications work (foreground & background)
  - [ ] ✅ FR11: Profile pictures work (upload & display)

## Dev Notes

### Testing Tools & Devices
[Source: docs/architecture.md#development-workflow]

**Physical Devices Required:**
- iOS device (iPhone) OR Android device
- At least 2 devices total (can be iOS + Android mix)
- Expo Go app installed OR development build

**Network Testing Tools:**
- iOS: Network Link Conditioner (in Settings → Developer)
- Android: Developer Options → Networking → Mobile data always active (off)
- Manual: Airplane mode for offline testing

**Firebase Tools:**
- Firebase Console: Monitor Firestore writes, Cloud Functions logs
- Firebase Emulator Suite: For local testing (optional for MVP)

### Error Handling Examples

**Network Error Handler:**
```typescript
// In messagesStore.sendMessage()
try {
  await messagesService.sendMessage(message);
} catch (error) {
  if (error.code === 'unavailable') {
    // Offline - queue for later
    await pendingMessageRepository.add(message);
    showToast('Message will send when connection restored');
  } else {
    // Other error - mark as failed
    set((state) => ({
      messagesByConversation: {
        ...state.messagesByConversation,
        [conversationId]: state.messagesByConversation[conversationId].map(m =>
          m.localId === localId ? { ...m, status: 'failed' } : m
        ),
      },
    }));
    showToast('Message failed to send. Tap to retry.');
  }
}
```

**Error Banner Component:**
```typescript
// ErrorBanner.tsx
export function ErrorBanner({ message, onRetry }: ErrorBannerProps) {
  return (
    <Banner
      visible
      actions={[
        {
          label: 'Retry',
          onPress: onRetry,
        },
        {
          label: 'Dismiss',
          onPress: () => {},
        },
      ]}
      icon="alert-circle"
    >
      {message}
    </Banner>
  );
}
```

### MVP Demo Script Template
```markdown
# MessageAI MVP Demo Script (5 minutes)

## Setup
- 2 devices: Device A (Alice), Device B (Bob)
- Both logged in to test accounts

## Demo Flow

### 1. Authentication (30 sec)
- Show signup screen, create account
- Show login screen
- Show logout and re-login

### 2. Core Messaging (1 min)
- Device A: Open conversation with Bob
- Send text message "Hello Bob!"
- Device B: Show message appears instantly
- Device B: Reply "Hi Alice!"
- Device A: Show reply appears

### 3. Optimistic UI (30 sec)
- Device A: Send message, point out instant appearance
- Point out status progression: sending → sent → delivered → read

### 4. Offline Support (1 min)
- Device A: Enable airplane mode
- Device A: Send 2 messages
- Show "queued" status with offline indicator
- Device A: Disable airplane mode
- Show messages sync and deliver

### 5. Group Chat (1 min)
- Device A: Create group with Bob and Charlie
- Device A: Send message in group
- Device B: Show message with sender name
- Device C: Show message received
- Show read receipts: "Read by 2"

### 6. Push Notifications (30 sec)
- Device B: Background app
- Device A: Send message to Bob
- Device B: Show system notification
- Tap notification, show app opens to conversation

### 7. Presence & Typing (30 sec)
- Show online indicator (green dot) in conversation list
- Device A: Start typing in chat
- Device B: Show "Alice is typing..."
- Stop typing, show indicator clears

### 8. Profile Pictures (30 sec)
- Show profile picture in conversation list
- Show group member avatars
- Show initials fallback for users without pictures

### Conclusion
- Recap: "All 11 MVP features working!"
- Mention: "Ready for AI features (Days 2-7)"
```

### Performance Checklist
[Source: docs/architecture.md#security-and-performance]
- [ ] FlatList optimized: `windowSize={10}`, `maxToRenderPerBatch={10}`
- [ ] Images lazy-loaded with `expo-image`
- [ ] No unnecessary re-renders (use `React.memo` on list items)
- [ ] Firestore listeners properly cleaned up (`unsubscribe()` in useEffect cleanup)
- [ ] SQLite queries use indexes (created in Story 1.5)

### Common Issues & Fixes
1. **Messages not syncing:** Check Firestore security rules
2. **Push notifications not working:** Verify FCM token is saved, check Cloud Function logs
3. **App crashes on launch:** Check for SQLite migration errors
4. **Typing indicator stuck:** Ensure timeout clears after 3 seconds
5. **Duplicate messages:** Ensure message ID is unique (use UUID)

### Testing
- **Manual testing:** Follow all tasks above on physical devices
- **Smoke test:** Run through demo script 3 times to ensure consistency
- **Edge cases:** Test force quit, poor network, rapid actions
- **Cross-platform:** Test on both iOS and Android if possible

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

## QA Results

_To be filled by QA agent_

