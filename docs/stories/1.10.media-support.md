# Story 1.10: Profile Pictures & Media Support

## Status
**Draft**

## Story

**As a** user,  
**I want** to upload a profile picture and send images in conversations,  
**so that** my identity is clear and I can share visual content.

## Acceptance Criteria

1. Profile picture upload on signup/settings using device camera or photo library
2. Images uploaded to Firebase Storage with path: `users/{userId}/profile.jpg`
3. Profile picture URL stored in Firestore `users` collection
4. Profile pictures displayed in: conversation list, chat screen, group participant list
5. Image message support: attach image button in chat input area
6. Images uploaded to Firebase Storage with path: `conversations/{conversationId}/images/{messageId}.jpg`
7. Image messages stored in Firestore with type: "image", imageURL field
8. Image messages displayed in chat with thumbnail that expands on tap
9. Image upload progress indicator shown during upload
10. Fallback to initials avatar when no profile picture set

## Tasks / Subtasks

- [ ] **Task 1: Install Image Picker** (AC: 1, 5)
  - [ ] Install: `npx expo install expo-image-picker`
  - [ ] Request camera and photo library permissions

- [ ] **Task 2: Create Image Upload Service** (AC: 2, 6, 9)
  - [ ] Create `mobile/src/services/storage/imageUploadService.ts`
  - [ ] Implement `uploadProfilePicture(userId, imageUri): Promise<string>`
  - [ ] Implement `uploadMessageImage(conversationId, messageId, imageUri): Promise<string>`
  - [ ] Use Firebase Storage SDK: `ref(storage, path)` and `uploadBytesResumable()`
  - [ ] Track upload progress for progress indicator

- [ ] **Task 3: Add Profile Picture Upload to Signup** (AC: 1, 2, 3)
  - [ ] Add "Upload Photo" button to SignupScreen
  - [ ] Launch ImagePicker: `launchImageLibraryAsync()` or `launchCameraAsync()`
  - [ ] On image selected: upload to Storage, get URL
  - [ ] Store URL in User document during signup

- [ ] **Task 4: Create Settings/Profile Screen** (AC: 1, 3)
  - [ ] Create `mobile/src/app/(tabs)/settings.tsx`
  - [ ] Display current profile picture
  - [ ] "Change Photo" button to upload new picture
  - [ ] Update Firestore user document with new URL

- [ ] **Task 5: Create Avatar Component with Initials Fallback** (AC: 4, 10)
  - [ ] Create `mobile/src/components/atoms/Avatar.tsx`
  - [ ] Props: `user: User, size: number`
  - [ ] If `user.profilePictureURL` exists: show image
  - [ ] Else: show circle with initials (first letter of displayName)
  - [ ] Use React Native Paper Avatar component

- [ ] **Task 6: Use Avatar Component Throughout App** (AC: 4)
  - [ ] Update ConversationListItem to use Avatar
  - [ ] Update MessageBubble (for groups) to use Avatar
  - [ ] Update ChatScreen header to use Avatar

- [ ] **Task 7: Add Image Attachment to ChatInput** (AC: 5)
  - [ ] Add image attachment IconButton (paperclip or camera icon)
  - [ ] On press: show ActionSheet with "Camera" and "Photo Library" options
  - [ ] Launch appropriate ImagePicker
  - [ ] On image selected: call `sendImageMessage()`

- [ ] **Task 8: Implement Send Image Message** (AC: 6, 7, 9)
  - [ ] In messagesStore: create `sendImageMessage(conversationId, imageUri)`
  - [ ] Generate message ID first
  - [ ] Upload image to Storage: `/conversations/{conversationId}/images/{messageId}.jpg`
  - [ ] Show upload progress (optimistic UI with progress bar)
  - [ ] On upload complete: create Message with type: 'image', imageURL: downloadURL
  - [ ] Write to Firestore

- [ ] **Task 9: Display Image Messages** (AC: 8)
  - [ ] Update MessageBubble to handle type: 'image'
  - [ ] Show thumbnail (200x200 with AspectRatio)
  - [ ] On tap: open full-screen image viewer
  - [ ] Use Expo Image for better performance: `npx expo install expo-image`

- [ ] **Task 10: Create Full-Screen Image Viewer** (AC: 8)
  - [ ] Create `mobile/src/components/organisms/ImageViewer.tsx`
  - [ ] Use Modal with black background
  - [ ] Show full-resolution image with pinch-to-zoom
  - [ ] Close button to dismiss

## Dev Notes

### Firebase Storage Setup
[Source: docs/architecture.md#tech-stack]
- Firebase Storage is already initialized in Story 1.1
- Storage reference: `storage` from `firebase/storage`

### Image Upload Service
```typescript
// imageUploadService.ts
import { ref, uploadBytesResumable, getDownloadURL } from 'firebase/storage';
import { storage } from '../firebase/config';

export async function uploadProfilePicture(
  userId: string,
  imageUri: string,
  onProgress?: (progress: number) => void
): Promise<string> {
  const response = await fetch(imageUri);
  const blob = await response.blob();
  
  const storageRef = ref(storage, `users/${userId}/profile.jpg`);
  const uploadTask = uploadBytesResumable(storageRef, blob);
  
  return new Promise((resolve, reject) => {
    uploadTask.on(
      'state_changed',
      (snapshot) => {
        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        onProgress?.(progress);
      },
      reject,
      async () => {
        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
        resolve(downloadURL);
      }
    );
  });
}

export async function uploadMessageImage(
  conversationId: string,
  messageId: string,
  imageUri: string,
  onProgress?: (progress: number) => void
): Promise<string> {
  const response = await fetch(imageUri);
  const blob = await response.blob();
  
  const storageRef = ref(
    storage,
    `conversations/${conversationId}/images/${messageId}.jpg`
  );
  const uploadTask = uploadBytesResumable(storageRef, blob);
  
  return new Promise((resolve, reject) => {
    uploadTask.on('state_changed', 
      (snapshot) => {
        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        onProgress?.(progress);
      },
      reject,
      async () => {
        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
        resolve(downloadURL);
      }
    );
  });
}
```

### Image Picker Integration
```typescript
// In SignupScreen or Settings
import * as ImagePicker from 'expo-image-picker';

const pickImage = async () => {
  // Request permissions
  const { status } = await ImagePicker.requestMediaLibraryPermissionsAsync();
  if (status !== 'granted') {
    alert('Sorry, we need camera roll permissions to upload photos!');
    return;
  }
  
  // Launch picker
  const result = await ImagePicker.launchImageLibraryAsync({
    mediaTypes: ImagePicker.MediaTypeOptions.Images,
    allowsEditing: true,
    aspect: [1, 1],
    quality: 0.8,
  });
  
  if (!result.canceled) {
    const imageUri = result.assets[0].uri;
    setUploadProgress(0);
    
    const downloadURL = await uploadProfilePicture(
      userId,
      imageUri,
      (progress) => setUploadProgress(progress)
    );
    
    // Update user document
    await updateDoc(doc(firestore, 'users', userId), {
      profilePictureURL: downloadURL,
    });
  }
};
```

### Avatar Component
```typescript
// Avatar.tsx
import { Avatar as PaperAvatar } from 'react-native-paper';

interface AvatarProps {
  user: User;
  size?: number;
}

export function Avatar({ user, size = 40 }: AvatarProps) {
  if (user.profilePictureURL) {
    return (
      <PaperAvatar.Image
        size={size}
        source={{ uri: user.profilePictureURL }}
      />
    );
  }
  
  // Fallback: initials
  const initials = user.displayName
    .split(' ')
    .map(word => word[0])
    .join('')
    .toUpperCase()
    .slice(0, 2);
  
  return (
    <PaperAvatar.Text
      size={size}
      label={initials}
    />
  );
}
```

### Send Image Message
```typescript
// messagesStore.ts
sendImageMessage: async (conversationId, imageUri) => {
  const messageId = uuidv4();
  const userId = useAuthStore.getState().user!.id;
  
  // Optimistic message with placeholder
  const message: Message = {
    id: messageId,
    conversationId,
    senderId: userId,
    type: 'image',
    content: '',
    imageURL: imageUri,  // Local URI temporarily
    timestamp: new Date(),
    status: 'sending',
    deliveredTo: [],
    readBy: [],
    localId: messageId,
  };
  
  set((state) => ({
    messagesByConversation: {
      ...state.messagesByConversation,
      [conversationId]: [...(state.messagesByConversation[conversationId] || []), message],
    },
  }));
  
  try {
    // Upload image
    const downloadURL = await uploadMessageImage(conversationId, messageId, imageUri);
    
    // Update message with real URL
    message.imageURL = downloadURL;
    
    // Write to Firestore
    await messagesService.sendMessage(message);
    
  } catch (error) {
    console.error('Failed to send image:', error);
    // Mark as failed
    set((state) => ({
      messagesByConversation: {
        ...state.messagesByConversation,
        [conversationId]: state.messagesByConversation[conversationId].map(m =>
          m.localId === messageId ? { ...m, status: 'failed' } : m
        ),
      },
    }));
  }
}
```

### Image Message Bubble
```typescript
// MessageBubble.tsx
import { Image } from 'expo-image';

export function MessageBubble({ message, isOwnMessage }: MessageBubbleProps) {
  if (message.type === 'image') {
    return (
      <TouchableOpacity onPress={() => openImageViewer(message.imageURL)}>
        <Image
          source={{ uri: message.imageURL }}
          style={{ width: 200, height: 200, borderRadius: 8 }}
          contentFit="cover"
        />
        {isOwnMessage && <StatusIcon status={message.status} />}
      </TouchableOpacity>
    );
  }
  
  // Text message rendering...
}
```

### Full-Screen Image Viewer
```typescript
// ImageViewer.tsx
import { Modal, View, Image } from 'react-native';
import { IconButton } from 'react-native-paper';

export function ImageViewer({ imageURL, visible, onClose }: ImageViewerProps) {
  return (
    <Modal visible={visible} transparent animationType="fade">
      <View style={{ flex: 1, backgroundColor: 'black' }}>
        <Image
          source={{ uri: imageURL }}
          style={{ flex: 1 }}
          resizeMode="contain"
        />
        <IconButton
          icon="close"
          size={30}
          iconColor="white"
          style={{ position: 'absolute', top: 40, right: 20 }}
          onPress={onClose}
        />
      </View>
    </Modal>
  );
}
```

### Firebase Storage Security Rules
[Source: docs/architecture.md#security-and-performance]

```
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Profile pictures
    match /users/{userId}/profile.jpg {
      allow read: if true;  // Public read
      allow write: if request.auth.uid == userId;  // Only own profile
    }
    
    // Message images
    match /conversations/{conversationId}/images/{imageId} {
      allow read: if request.auth != null;  // Authenticated users
      allow write: if request.auth != null;  // Any authenticated user can upload
      // TODO: Add participant check (requires Firestore query in rules)
    }
  }
}
```

### Testing
- **Profile upload:** Upload profile picture, verify appears in conversation list
- **Image message:** Send image, verify appears as thumbnail
- **Full screen:** Tap image thumbnail, verify opens full screen viewer
- **Progress:** Upload large image, verify progress indicator shows
- **Fallback:** Delete profile picture, verify initials avatar appears
- **Groups:** Send image in group, verify all members see it

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

_To be filled by dev agent_

## QA Results

_To be filled by QA agent_

