# Story 1.7: Group Chat Functionality

## Status
**Draft**

## Story

**As a** user,  
**I want** to create group conversations and message multiple people at once,  
**so that** I can coordinate with teams or friend groups.

## Acceptance Criteria

1. Create group screen with participant selection from user's contacts
2. Group conversation created in Firestore with type: "group", participants[] array (3+ users)
3. Group name and optional group picture (can use placeholder icon for MVP)
4. Group messages display sender name/picture for attribution (unlike 1-on-1 where it's implied)
5. All group participants see messages in real-time via Firestore listeners
6. Group conversation appears in conversation list for all participants
7. Message delivery tracking works for groups (delivered when all participants acknowledge)
8. Read receipts show count of how many participants have read (e.g., "Read by 3")
9. Firestore security rules ensure only group participants can send/read messages

## Tasks / Subtasks

- [ ] **Task 1: Create Contacts Service** (AC: 1)
  - [ ] Create `mobile/src/services/firestore/contactsService.ts`
  - [ ] Implement `getAllUsers(): Promise<User[]>` (query all users for MVP)
  - [ ] Implement `searchUsers(query): Promise<User[]>` for future use
  - [ ] NOTE: For MVP, show all users as potential contacts

- [ ] **Task 2: Create Group Creation Screen** (AC: 1, 2, 3)
  - [ ] Create `mobile/src/app/(tabs)/new-group.tsx`
  - [ ] Show searchable list of all users (from contactsService)
  - [ ] Multi-select checkbox list for participant selection
  - [ ] Group name TextInput (required)
  - [ ] Group picture placeholder (use default icon for MVP)
  - [ ] "Create Group" button (disabled until 2+ participants + name)
  - [ ] Call `conversationsService.createGroupConversation()`

- [ ] **Task 3: Implement Create Group Conversation** (AC: 2, 3, 6)
  - [ ] Add to `conversationsService.ts`: `createGroupConversation(name, participantIds)`
  - [ ] Validate: minimum 3 participants (creator + 2 others)
  - [ ] Create Firestore doc in `/conversations` with:
    - type: 'group'
    - name: groupName
    - participants: [creatorId, ...participantIds]
    - groupPictureURL: null
    - createdBy: currentUserId
  - [ ] Navigate to new group chat after creation

- [ ] **Task 4: Update MessageBubble for Group Attribution** (AC: 4)
  - [ ] Add `conversationType` prop to MessageBubble
  - [ ] If type === 'group' AND not own message:
    - Show sender's display name above message bubble
    - Show sender's profile picture to left of bubble
  - [ ] Fetch sender User object for display name

- [ ] **Task 5: Update ConversationListItem for Groups** (AC: 6)
  - [ ] Display group icon if conversation.type === 'group'
  - [ ] Show group name instead of contact name
  - [ ] Show participant count: "{name} · {participantCount} members"

- [ ] **Task 6: Implement Group Message Delivery Tracking** (AC: 7)
  - [ ] Update `markAsDelivered()` to work for groups
  - [ ] Message is 'delivered' when `deliveredTo.length === participants.length - 1` (exclude sender)
  - [ ] Show "Delivered to {count}" in status if partial delivery

- [ ] **Task 7: Implement Group Read Receipts** (AC: 8)
  - [ ] Update `markAsRead()` to work for groups
  - [ ] In MessageBubble: show "Read by {count}" instead of checkmarks
  - [ ] Optional: Show list of who read on long-press (can defer to post-MVP)

- [ ] **Task 8: Update Security Rules for Groups** (AC: 9)
  - [ ] Firestore rules already check `isParticipant()` - should work for groups
  - [ ] Test: Non-participant cannot read group messages
  - [ ] Test: Participant can send message

## Dev Notes

### Group Conversation Data Model
[Source: docs/architecture.md#data-models]

```typescript
// Conversation interface already supports groups
interface Conversation {
  id: string;
  type: 'direct' | 'group';  // Use 'group'
  name: string | null;        // Required for groups
  participants: string[];     // 3+ users
  lastMessage: string | null;
  lastMessageTimestamp: Date | null;
  groupPictureURL: string | null;  // null for MVP
  createdAt: Date;
  createdBy: string;
}
```

### Create Group Conversation
```typescript
// conversationsService.ts
export async function createGroupConversation(
  name: string,
  participantIds: string[],
  creatorId: string
): Promise<string> {
  if (participantIds.length < 2) {
    throw new Error('Group must have at least 3 participants (including you)');
  }
  
  const allParticipants = [creatorId, ...participantIds];
  
  const conversationData: Omit<Conversation, 'id'> = {
    type: 'group',
    name,
    participants: allParticipants,
    lastMessage: null,
    lastMessageTimestamp: null,
    groupPictureURL: null,
    createdAt: serverTimestamp(),
    createdBy: creatorId,
  };
  
  const docRef = await addDoc(collection(firestore, 'conversations'), conversationData);
  
  return docRef.id;
}
```

### Group Message Bubble
```typescript
// MessageBubble.tsx
export function MessageBubble({ 
  message, 
  isOwnMessage,
  conversationType,
  sender,  // User object
}: MessageBubbleProps) {
  return (
    <View style={isOwnMessage ? styles.ownMessage : styles.otherMessage}>
      {/* Show sender info for groups */}
      {conversationType === 'group' && !isOwnMessage && (
        <View style={styles.groupSenderInfo}>
          <Avatar source={{ uri: sender.profilePictureURL }} size={32} />
          <Text style={styles.senderName}>{sender.displayName}</Text>
        </View>
      )}
      
      <View style={styles.bubble}>
        <Text>{message.content}</Text>
        <View style={styles.metadata}>
          <Text style={styles.timestamp}>{formatTime(message.timestamp)}</Text>
          {isOwnMessage && <StatusIcon status={message.status} />}
        </View>
      </View>
    </View>
  );
}
```

### Group Read Receipt Status
```typescript
// For groups, calculate read status
function getGroupReadStatus(message: Message, participants: string[]): string {
  const readCount = message.readBy.length;
  const totalRecipients = participants.length - 1;  // Exclude sender
  
  if (readCount === 0) return '';
  if (readCount === totalRecipients) return 'Read by all';
  return `Read by ${readCount}`;
}
```

### Firestore Security Rules for Groups
[Source: docs/architecture.md#database-schema]

```
// Security rules already handle groups via isParticipant() helper
function isParticipant(conversationId) {
  return request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
}

// This works for both direct and group conversations!
match /conversations/{conversationId}/messages/{messageId} {
  allow read, write: if request.auth != null && isParticipant(conversationId);
}
```

### New Group Screen UI
```typescript
// new-group.tsx
export default function NewGroupScreen() {
  const [selectedUsers, setSelectedUsers] = useState<string[]>([]);
  const [groupName, setGroupName] = useState('');
  const [users, setUsers] = useState<User[]>([]);
  
  useEffect(() => {
    contactsService.getAllUsers().then(setUsers);
  }, []);
  
  const handleCreate = async () => {
    if (selectedUsers.length < 2 || !groupName.trim()) return;
    
    const conversationId = await conversationsService.createGroupConversation(
      groupName,
      selectedUsers,
      currentUserId
    );
    
    router.replace(`/chat/${conversationId}`);
  };
  
  return (
    <View>
      <TextInput 
        label="Group Name"
        value={groupName}
        onChangeText={setGroupName}
      />
      
      <FlatList
        data={users}
        renderItem={({ item }) => (
          <Checkbox.Item
            label={item.displayName}
            status={selectedUsers.includes(item.id) ? 'checked' : 'unchecked'}
            onPress={() => toggleUser(item.id)}
          />
        )}
      />
      
      <Button 
        onPress={handleCreate}
        disabled={selectedUsers.length < 2 || !groupName.trim()}
      >
        Create Group ({selectedUsers.length + 1} members)
      </Button>
    </View>
  );
}
```

### Testing
- **Manual:** Create group with 3 users, send message, verify all see it
- **Attribution:** Verify sender name appears on group messages
- **Real-time:** Send from user A, verify B and C receive instantly
- **Read receipts:** Open chat on B, verify "Read by 1" on A's device
- **Security:** Try to access group messages from non-member → denied

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

_To be filled by dev agent_

## QA Results

_To be filled by QA agent_

